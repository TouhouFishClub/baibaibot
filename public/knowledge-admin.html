<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>çŸ¥è¯†åº“ç®¡ç†</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 1600px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 30px;
    }
    h1 {
      margin-bottom: 30px;
      color: #333;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
    }
    .main-layout {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }
    .left-panel {
      flex: 1;
      min-width: 0;
    }
    .right-panel {
      width: 500px;
      flex-shrink: 0;
      position: sticky;
      top: 20px;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
    }
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .search-box {
      flex: 1;
      min-width: 200px;
      position: relative;
    }
    .search-box input {
      width: 100%;
      padding: 10px 40px 10px 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .search-box::after {
      content: 'ğŸ”';
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    .btn-primary {
      background: #4CAF50;
      color: white;
    }
    .btn-primary:hover {
      background: #45a049;
    }
    .btn-danger {
      background: #f44336;
      color: white;
    }
    .btn-danger:hover {
      background: #da190b;
    }
    .btn-secondary {
      background: #2196F3;
      color: white;
    }
    .btn-secondary:hover {
      background: #0b7dda;
    }
    .knowledge-list {
      margin-bottom: 20px;
      min-height: 400px;
    }
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .pagination-info {
      color: #666;
      font-size: 14px;
      margin: 0 10px;
    }
    .pagination button {
      padding: 8px 15px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    .pagination button:hover:not(:disabled) {
      background: #f0f0f0;
      border-color: #4CAF50;
    }
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .pagination button.active {
      background: #4CAF50;
      color: white;
      border-color: #4CAF50;
    }
    .page-size-selector {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    .page-size-selector select {
      padding: 5px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .knowledge-item {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .knowledge-item:hover {
      background: #f0f0f0;
      border-color: #4CAF50;
    }
    .knowledge-item.active {
      background: #e8f5e9;
      border-color: #4CAF50;
    }
    .knowledge-item-title {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }
    .knowledge-item-meta {
      font-size: 12px;
      color: #666;
    }
    .knowledge-item-keywords {
      margin-top: 5px;
    }
    .keyword-tag {
      display: inline-block;
      background: #e3f2fd;
      color: #1976d2;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      margin-right: 5px;
    }
    .form-container {
      background: #f9f9f9;
      border-radius: 4px;
      padding: 20px;
      border: 2px solid #4CAF50;
    }
    .form-container:empty {
      display: none;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .form-group textarea {
      min-height: 100px;
      font-family: monospace;
    }
    .form-group input[type="text"] {
      height: 36px;
    }
    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .preview-container {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-height: 200px;
    }
    .preview-title {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #666;
    }
    .preview-content {
      line-height: 1.6;
    }
    .preview-content h1, .preview-content h2, .preview-content h3 {
      margin-top: 20px;
      margin-bottom: 10px;
    }
    .preview-content p {
      margin-bottom: 10px;
    }
    .preview-content ul, .preview-content ol {
      margin-left: 20px;
      margin-bottom: 10px;
    }
    .preview-content code {
      background: #f4f4f4;
      padding: 2px 4px;
      border-radius: 3px;
      font-family: monospace;
    }
    .preview-content pre {
      background: #f4f4f4;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .preview-content mark {
      background: #ffeb3b;
      padding: 2px 4px;
      border-radius: 2px;
    }
    .message {
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 20px;
      display: none;
    }
    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .tabs {
      display: flex;
      border-bottom: 2px solid #ddd;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 14px;
      color: #666;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
    }
    .tab.active {
      color: #4CAF50;
      border-bottom-color: #4CAF50;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“š çŸ¥è¯†åº“ç®¡ç†</h1>
    
    <div id="message" class="message"></div>
    
    <div class="main-layout">
      <div class="left-panel">
        <div class="toolbar">
          <div class="search-box">
            <input type="text" id="searchInput" placeholder="æœç´¢æ ‡é¢˜ã€å†…å®¹ã€å…³é”®è¯æˆ–åˆ†ç±»..." oninput="handleSearch()" />
          </div>
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="showAddForm()">â• æ·»åŠ çŸ¥è¯†</button>
            <button class="btn btn-secondary" onclick="loadKnowledgeList()">ğŸ”„ åˆ·æ–°</button>
          </div>
        </div>
        
        <div class="knowledge-list" id="knowledgeList">
          <p>åŠ è½½ä¸­...</p>
        </div>
        
        <div class="pagination" id="pagination"></div>
        <div class="page-size-selector">
          <span>æ¯é¡µæ˜¾ç¤ºï¼š</span>
          <select id="pageSizeSelect" onchange="changePageSize()">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
      </div>
      
      <div class="right-panel">
        <div class="form-container" id="formContainer" style="display: none;">
          <div class="tabs">
            <button class="tab active" onclick="switchTab('edit')">ç¼–è¾‘</button>
            <button class="tab" onclick="switchTab('preview')">é¢„è§ˆ</button>
          </div>
          
          <div id="editTab">
            <form id="knowledgeForm" onsubmit="saveKnowledge(event)">
              <input type="hidden" id="knowledgeId" />
              
              <div class="form-group">
                <label for="title">æ ‡é¢˜ *</label>
                <input type="text" id="title" required />
              </div>
              
              <div class="form-group">
                <label for="content">å†…å®¹ * (æ”¯æŒ Markdown)</label>
                <textarea id="content" required rows="10"></textarea>
              </div>
              
              <div class="form-group">
                <label for="keywords">å…³é”®è¯ (ç”¨é€—å·ã€é¡¿å·æˆ–ç©ºæ ¼åˆ†éš”)</label>
                <input type="text" id="keywords" placeholder="ä¾‹å¦‚ï¼šæ´›å¥‡,è·‘å•†,æ”»ç•¥" />
              </div>
              
              <div class="form-group">
                <label for="category">åˆ†ç±»</label>
                <input type="text" id="category" value="é€šç”¨" />
              </div>
              
              <div class="form-actions">
                <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
                <button type="button" class="btn btn-secondary" onclick="cancelEdit()">âŒ å–æ¶ˆ</button>
              </div>
            </form>
          </div>
          
          <div id="previewTab" style="display: none;">
            <div class="preview-container">
              <div class="preview-title">é¢„è§ˆæ•ˆæœ</div>
              <div class="preview-content" id="previewContent"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let currentKnowledge = null;
    let allKnowledge = [];
    let filteredKnowledge = [];
    let currentPage = 1;
    let pageSize = 20;
    let searchQuery = '';
    
    // åŠ è½½çŸ¥è¯†åˆ—è¡¨
    async function loadKnowledgeList() {
      try {
        const response = await fetch('/api/knowledge/list', {
          credentials: 'include'
        });
        
        if (response.status === 401) {
          window.location.reload();
          return;
        }
        
        const data = await response.json();
        
        if (data.success) {
          allKnowledge = data.data;
          handleSearch();
        } else {
          showMessage(data.message || 'åŠ è½½å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error);
        showMessage('åŠ è½½å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // å¤„ç†æœç´¢
    function handleSearch() {
      searchQuery = document.getElementById('searchInput').value.trim().toLowerCase();
      
      if (!searchQuery) {
        filteredKnowledge = allKnowledge;
      } else {
        filteredKnowledge = allKnowledge.filter(item => {
          const title = (item.title || '').toLowerCase();
          const contentPreview = (item.contentPreview || '').toLowerCase();
          const category = (item.category || '').toLowerCase();
          const keywords = (item.keywords || []).join(' ').toLowerCase();
          
          return title.includes(searchQuery) || 
                 contentPreview.includes(searchQuery) || 
                 category.includes(searchQuery) || 
                 keywords.includes(searchQuery);
        });
      }
      
      currentPage = 1;
      renderKnowledgeList();
      renderPagination();
    }
    
    // æ”¹å˜æ¯é¡µæ˜¾ç¤ºæ•°é‡
    function changePageSize() {
      pageSize = parseInt(document.getElementById('pageSizeSelect').value);
      currentPage = 1;
      renderKnowledgeList();
      renderPagination();
    }
    
    // æ¸²æŸ“çŸ¥è¯†åˆ—è¡¨
    function renderKnowledgeList() {
      const container = document.getElementById('knowledgeList');
      
      if (filteredKnowledge.length === 0) {
        container.innerHTML = searchQuery 
          ? '<p>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„çŸ¥è¯†æ¡ç›®</p>'
          : '<p>æš‚æ— çŸ¥è¯†æ¡ç›®</p>';
        return;
      }
      
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageData = filteredKnowledge.slice(start, end);
      
      container.innerHTML = pageData.map(item => {
        const keywords = (item.keywords || []).map(k => 
          `<span class="keyword-tag">${k}</span>`
        ).join('');
        
        // é«˜äº®æœç´¢å…³é”®è¯
        let title = escapeHtml(item.title);
        if (searchQuery) {
          const regex = new RegExp(`(${escapeRegex(searchQuery)})`, 'gi');
          title = title.replace(regex, '<mark>$1</mark>');
        }
        
        return `
          <div class="knowledge-item ${currentKnowledge && currentKnowledge.id === item.id ? 'active' : ''}" onclick="event.stopPropagation(); editKnowledge('${item.id}')">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
              <div style="flex: 1;">
                <div class="knowledge-item-title">${title}</div>
                <div class="knowledge-item-meta">
                  åˆ†ç±»: ${escapeHtml(item.category || 'é€šç”¨')} | 
                  åˆ›å»ºæ—¶é—´: ${formatDate(item.createdAt)}
                </div>
                ${keywords ? `<div class="knowledge-item-keywords">${keywords}</div>` : ''}
              </div>
              <button class="btn btn-danger" style="margin-left: 10px; padding: 5px 10px; font-size: 12px;" onclick="event.stopPropagation(); deleteKnowledge('${item.id}')">åˆ é™¤</button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // æ¸²æŸ“åˆ†é¡µ
    function renderPagination() {
      const container = document.getElementById('pagination');
      const totalPages = Math.ceil(filteredKnowledge.length / pageSize);
      
      if (totalPages <= 1) {
        container.innerHTML = '';
        return;
      }
      
      let html = '';
      
      // ä¸Šä¸€é¡µæŒ‰é’®
      html += `<button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;
      
      // é¡µç æŒ‰é’®
      const maxVisible = 7;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
      let endPage = Math.min(totalPages, startPage + maxVisible - 1);
      
      if (endPage - startPage < maxVisible - 1) {
        startPage = Math.max(1, endPage - maxVisible + 1);
      }
      
      if (startPage > 1) {
        html += `<button onclick="goToPage(1)">1</button>`;
        if (startPage > 2) {
          html += `<span>...</span>`;
        }
      }
      
      for (let i = startPage; i <= endPage; i++) {
        html += `<button class="${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
      }
      
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          html += `<span>...</span>`;
        }
        html += `<button onclick="goToPage(${totalPages})">${totalPages}</button>`;
      }
      
      // ä¸‹ä¸€é¡µæŒ‰é’®
      html += `<button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;
      
      // åˆ†é¡µä¿¡æ¯
      const start = (currentPage - 1) * pageSize + 1;
      const end = Math.min(currentPage * pageSize, filteredKnowledge.length);
      html += `<span class="pagination-info">ç¬¬ ${start}-${end} æ¡ï¼Œå…± ${filteredKnowledge.length} æ¡</span>`;
      
      container.innerHTML = html;
    }
    
    // è·³è½¬åˆ°æŒ‡å®šé¡µ
    function goToPage(page) {
      const totalPages = Math.ceil(filteredKnowledge.length / pageSize);
      if (page < 1 || page > totalPages) return;
      
      currentPage = page;
      renderKnowledgeList();
      renderPagination();
      
      // æ»šåŠ¨åˆ°åˆ—è¡¨é¡¶éƒ¨
      document.getElementById('knowledgeList').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // ç¼–è¾‘çŸ¥è¯†
    async function editKnowledge(id) {
      const item = allKnowledge.find(k => k.id === id);
      if (!item) return;
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      document.getElementById('formContainer').style.display = 'block';
      switchTab('edit');
      document.getElementById('title').value = 'åŠ è½½ä¸­...';
      document.getElementById('content').value = 'åŠ è½½ä¸­...';
      document.getElementById('keywords').value = '';
      document.getElementById('category').value = 'é€šç”¨';
      
      try {
        // ä»APIåŠ è½½å®Œæ•´å†…å®¹
        const response = await fetch(`/api/knowledge/get?id=${id}`, {
          credentials: 'include'
        });
        
        if (response.status === 401) {
          window.location.reload();
          return;
        }
        
        const data = await response.json();
        
        if (data.success && data.data) {
          const fullItem = data.data;
          currentKnowledge = fullItem;
          document.getElementById('knowledgeId').value = fullItem.id;
          document.getElementById('title').value = fullItem.title;
          document.getElementById('content').value = fullItem.content || '';
          document.getElementById('keywords').value = (fullItem.keywords || []).join(', ');
          document.getElementById('category').value = fullItem.category || 'é€šç”¨';
          updatePreview();
        } else {
          showMessage(data.message || 'åŠ è½½å¤±è´¥', 'error');
          document.getElementById('formContainer').style.display = 'none';
        }
      } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error);
        showMessage('åŠ è½½å¤±è´¥: ' + error.message, 'error');
        document.getElementById('formContainer').style.display = 'none';
      }
      
      // æ›´æ–°åˆ—è¡¨ä¸­çš„é«˜äº®çŠ¶æ€
      renderKnowledgeList();
    }
    
    // æ˜¾ç¤ºæ·»åŠ è¡¨å•
    function showAddForm() {
      currentKnowledge = null;
      document.getElementById('knowledgeForm').reset();
      document.getElementById('knowledgeId').value = '';
      document.getElementById('category').value = 'é€šç”¨';
      document.getElementById('formContainer').style.display = 'block';
      switchTab('edit');
      document.getElementById('previewContent').innerHTML = '';
      
      // æ›´æ–°åˆ—è¡¨ä¸­çš„é«˜äº®çŠ¶æ€
      renderKnowledgeList();
    }
    
    // ä¿å­˜çŸ¥è¯†
    async function saveKnowledge(event) {
      event.preventDefault();
      
      const id = document.getElementById('knowledgeId').value;
      const title = document.getElementById('title').value.trim();
      const content = document.getElementById('content').value.trim();
      const keywordsStr = document.getElementById('keywords').value.trim();
      const category = document.getElementById('category').value.trim() || 'é€šç”¨';
      
      if (!title || !content) {
        showMessage('æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
        return;
      }
      
      const keywords = keywordsStr 
        ? keywordsStr.split(/[,ï¼Œã€\s]+/).map(k => k.trim()).filter(k => k)
        : [];
      
      const data = {
        title,
        content,
        keywords,
        category
      };
      
      if (id) {
        data.id = id;
      }
      
      try {
        const url = id ? '/api/knowledge/update' : '/api/knowledge/add';
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        
        if (response.status === 401) {
          window.location.reload();
          return;
        }
        
        const result = await response.json();
        
        if (result.success) {
          showMessage(id ? 'æ›´æ–°æˆåŠŸ' : 'æ·»åŠ æˆåŠŸ', 'success');
          await loadKnowledgeList();
          if (id) {
            // å¦‚æœæ˜¯æ›´æ–°ï¼Œä¿æŒç¼–è¾‘çŠ¶æ€å¹¶é«˜äº®
            const updatedItem = allKnowledge.find(k => k.id === id);
            if (updatedItem) {
              editKnowledge(id);
            }
          } else {
            cancelEdit();
          }
        } else {
          showMessage(result.message || 'ä¿å­˜å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('ä¿å­˜å¤±è´¥:', error);
        showMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // åˆ é™¤çŸ¥è¯†
    async function deleteKnowledge(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡çŸ¥è¯†å—ï¼Ÿ')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/knowledge/delete?id=${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (response.status === 401) {
          window.location.reload();
          return;
        }
        
        const result = await response.json();
        
        if (result.success) {
          showMessage('åˆ é™¤æˆåŠŸ', 'success');
          await loadKnowledgeList();
          cancelEdit();
        } else {
          showMessage(result.message || 'åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('åˆ é™¤å¤±è´¥:', error);
        showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // å–æ¶ˆç¼–è¾‘
    function cancelEdit() {
      document.getElementById('formContainer').style.display = 'none';
      currentKnowledge = null;
    }
    
    // åˆ‡æ¢æ ‡ç­¾
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById('editTab').style.display = tab === 'edit' ? 'block' : 'none';
      document.getElementById('previewTab').style.display = tab === 'preview' ? 'block' : 'none';
      
      if (tab === 'preview') {
        updatePreview();
      }
    }
    
    // æ›´æ–°é¢„è§ˆ
    function updatePreview() {
      const content = document.getElementById('content').value;
      const previewContent = document.getElementById('previewContent');
      
      if (marked) {
        previewContent.innerHTML = marked.parse(content);
      } else {
        previewContent.textContent = content;
      }
    }
    
    // ç›‘å¬å†…å®¹å˜åŒ–
    document.getElementById('content').addEventListener('input', updatePreview);
    
    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(message, type) {
      const msgEl = document.getElementById('message');
      msgEl.textContent = message;
      msgEl.className = `message ${type}`;
      msgEl.style.display = 'block';
      
      setTimeout(() => {
        msgEl.style.display = 'none';
      }, 3000);
    }
    
    // å·¥å…·å‡½æ•°
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return 'æœªçŸ¥';
      const date = new Date(dateStr);
      return date.toLocaleString('zh-CN');
    }
    
    function escapeRegex(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.addEventListener('load', () => {
      loadKnowledgeList();
    });
  </script>
</body>
</html>

