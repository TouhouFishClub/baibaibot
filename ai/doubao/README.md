# 豆包 AI 图片生成插件

基于火山引擎豆包模型（SeeDream）的图片生成插件，支持文本到图片和图片到图片的生成。

## 目录结构

```
ai/doubao/
├── index.js          # 主插件文件
└── README.md         # 使用说明文档
```

## 功能特性

- 🎨 基于文本提示词生成图片
- 🖼️ 支持参考图片进行图片生成
- 🔄 支持回复消息生成图片
- ⚡ 完全异步，支持多用户并发调用
- 🍃 简单易用的 doubao 命令触发
- 📁 自动下载并保存生成的图片到本地
- 🔒 从同文件夹下的 .secret.json 读取密钥配置

## 安装配置

### 1. API密钥配置

在 `ai/doubao/.secret.json` 文件中添加豆包的配置：

```json
{
  "apiKey": "acc59b5c-c423-45a8-adae-b04268d2dcd5"
}
```

**配置说明：**
- `apiKey`（必填）：火山引擎豆包 API 的授权密钥（Bearer Token）

### 2. 获取API密钥

1. 访问火山引擎控制台
2. 开通豆包图像生成服务
3. 在 API 密钥管理页面获取 Bearer Token
4. 将密钥填入 `ai/doubao/.secret.json` 文件的 `apiKey` 字段

## 使用方法

### 基本用法

```
doubao [提示词]
```

示例：
```
doubao 一只可爱的小猫咪
doubao 美丽的风景画，油画风格
doubao Generate 3 images of a girl and a cow plushie happily riding a roller coaster
```

### 基于参考图片生成

#### 1. 回复图片消息（推荐）

直接回复包含图片的消息，然后发送 doubao 命令：

```
[回复一张图片消息]
doubao 转换成油画风格
```

特点：
- ✅ 最方便快捷
- ✅ 自动提取回复消息中的图片
- ✅ 如果回复的消息没有图片会自动拒绝以节省API用量

#### 2. 通过图片URL

```
doubao [提示词] [图片URL]
```

示例：
```
doubao 把这张图片变成动漫风格 https://example.com/image.jpg
doubao 改变颜色为蓝色调 https://example.com/photo.png
```

#### 3. 直接发送图片

```
doubao [提示词] [发送图片]
```

在聊天中直接发送图片，系统会自动识别：
```
doubao 动漫风格 [发送一张图片]
doubao 转换成油画效果 [发送一张图片]
```

### 获取帮助

```
doubao help
```

## API说明

插件使用火山引擎的豆包图像生成接口：
- 接口地址：`https://ark.cn-beijing.volces.com/api/v3/images/generations`
- 模型名称：`doubao-seedream-4-0-250828`
- 默认分辨率：2K
- 默认添加水印

## 权限控制

插件实现了白名单机制，仅允许以下用户使用：

### 白名单群组
- 群组ID: `577587780`

### 白名单用户
- 用户ID: `799018865`
- 用户ID: `2408709050`
- 用户ID: `540540678`

满足以下任一条件即可使用：
1. 在白名单群组中的任何用户
2. 白名单用户在任何群组中

非白名单用户将收到"抱歉，您暂无权限使用豆包图片生成功能。"的提示。

## 注意事项

1. **API密钥**：使用前必须在 `ai/doubao/.secret.json` 中配置有效的API密钥
2. **权限限制**：仅白名单群组和用户可以使用此功能
3. **网络要求**：需要稳定的网络连接访问火山引擎API
4. **图片URL**：参考图片URL必须是公网可访问的链接
5. **生成时间**：图片生成需要一定时间，请耐心等待
6. **存储位置**：生成的图片保存在 `coolq-data/cq/data/image/send/doubao/`

## 错误处理

- 未配置API密钥：会提示"错误：未配置豆包 API 密钥，请在ai/doubao/.secret.json中添加apiKey字段"
- 网络错误：会提示"网络请求失败"
- API错误：会显示具体的API错误信息
- 图片下载失败：会提示下载失败原因

## 技术实现

### 主要流程

1. **解析输入**: 提取提示词和参考图片URL
2. **调用API**: POST请求到豆包图像生成接口
3. **获取结果**: 从响应中提取图片URL
4. **下载图片**: 将生成的图片下载到本地存储
5. **返回结果**: 返回CQ码格式的图片消息

### 支持的参数

- `model`: 模型名称（默认：doubao-seedream-4-0-250828）
- `prompt`: 文本提示词
- `image`: 参考图片URL数组（可选）
- `response_format`: 响应格式（默认：url）
- `size`: 图片尺寸（默认：2K）
- `watermark`: 是否添加水印（默认：true）

## 更新日志

- v1.0.0 (2025-01-12)
  - 初始版本发布
  - 支持文本到图片生成
  - 支持参考图片生成
  - 自动图片下载和本地存储
  - 基于 banana 插件的架构设计

